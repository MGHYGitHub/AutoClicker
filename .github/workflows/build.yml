name: Build AutoClicker

on:
  push:
    tags: ['v*']
  pull_request:
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ['3.9', '3.10', '3.11']  # 移除了 3.8 避免安装问题
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30  # 增加超时时间
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'  # 启用 pip 缓存
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyautogui pystray Pillow keyboard requests pyinstaller --timeout 60 --retries 3
        
    - name: Create build info file
      shell: cmd
      run: |
        echo "Build Date: %date% %time%" > build_info.txt
        echo "Commit: ${{ github.sha }}" >> build_info.txt
        echo "Python Version: ${{ matrix.python-version }}" >> build_info.txt
        echo "OS: ${{ matrix.os }}" >> build_info.txt
        
    - name: Convert PNG to ICO (if icon.png exists)
      shell: pwsh  # 使用 PowerShell 而不是 CMD
      run: |
        if (Test-Path "icon.png") {
          python -c "
          from PIL import Image
          import os
          
          sizes = [(16, 16), (32, 32), (48, 48), (64, 64), (128, 128)]
          img = Image.open('icon.png')
          icon_images = []
          
          for size in sizes:
              resized_img = img.resize(size, Image.Resampling.LANCZOS)
              icon_images.append(resized_img)
          
          icon_images[0].save(
              'icon.ico',
              format='ICO',
              sizes=[(img.width, img.height) for img in icon_images],
              append_images=icon_images[1:]
          )
          print('✅ Created icon.ico from icon.png')
          "
        } else {
          Write-Host "⚠️ No icon.png found, building without custom icon"
        }
        
    - name: Build AutoClicker (Single File)
      shell: cmd
      run: |
        if exist "icon.ico" (
          echo Building with custom icon...
          pyinstaller --onefile --windowed --noconfirm --clean --name "AutoClicker_v2.4_%PYTHON_VERSION%_Windows" --icon=icon.ico --hidden-import=pystray._win32 --hidden-import=PIL._imaging --hidden-import=PIL._imagingft --hidden-import=keyboard._winkeyboard --hidden-import=keyboard._nixkeyboard --add-data "build_info.txt;." autoclicker.py
        ) else (
          echo Building without custom icon...
          pyinstaller --onefile --windowed --noconfirm --clean --name "AutoClicker_v2.4_%PYTHON_VERSION%_Windows" --hidden-import=pystray._win32 --hidden-import=PIL._imaging --hidden-import=PIL._imagingft --hidden-import=keyboard._winkeyboard --hidden-import=keyboard._nixkeyboard --add-data "build_info.txt;." autoclicker.py
        )
          
    - name: Build AutoClicker (Console Version)
      shell: cmd
      run: |
        if exist "icon.ico" (
          echo Building with custom icon...
          pyinstaller --onefile --console --noconfirm --clean --name "AutoClicker_v2.4_%PYTHON_VERSION%_Console" --icon=icon.ico --hidden-import=pystray._win32 --hidden-import=PIL._imaging --hidden-import=PIL._imagingft --hidden-import=keyboard._winkeyboard --hidden-import=keyboard._nixkeyboard --add-data "build_info.txt;." autoclicker.py
        ) else (
          echo Building without custom icon...
          pyinstaller --onefile --console --noconfirm --clean --name "AutoClicker_v2.4_%PYTHON_VERSION%_Console" --hidden-import=pystray._win32 --hidden-import=PIL._imaging --hidden-import=PIL._imagingft --hidden-import=keyboard._winkeyboard --hidden-import=keyboard._nixkeyboard --add-data "build_info.txt;." autoclicker.py
        )
          
    - name: Create release assets
      shell: cmd
      run: |
        mkdir release_assets
        copy dist\*.exe release_assets\
        echo "AutoClicker v2.4" > release_assets\README.txt
        echo "================" >> release_assets\README.txt
        echo. >> release_assets\README.txt
        echo "Build Info:" >> release_assets\README.txt
        type build_info.txt >> release_assets\README.txt
        echo. >> release_assets\README.txt
        echo "Usage:" >> release_assets\README.txt
        echo "- F2: Capture coordinates" >> release_assets\README.txt
        echo "- F3: Start/Stop task" >> release_assets\README.txt
        echo "- F4: Pause/Resume task" >> release_assets\README.txt
        echo. >> release_assets\README.txt
        echo "Features:" >> release_assets\README.txt
        echo "- Multi-point auto clicking" >> release_assets\README.txt
        echo "- Per-point click count and interval settings" >> release_assets\README.txt
        echo "- Global hotkeys support" >> release_assets\README.txt
        echo "- System tray integration" >> release_assets\README.txt
        echo "- Safety detection" >> release_assets\README.txt
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AutoClicker-${{ matrix.python-version }}-${{ matrix.os }}
        path: |
          release_assets/
          dist/
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release_assets/*
        body: |
          AutoClicker v2.4 Release
          
          ### New Features:
          - Per-point independent click count and interval settings
          - Enhanced safety detection mechanism
          - About dialog with project information
          - Custom application icon support
          
          ### Features:
          - Multi-point auto clicking with independent settings
          - Global hotkeys support (F2, F3, F4)
          - System tray integration
          - Safety movement detection
          - Theme support (Light/Dark)
          
          ### Build Information:
          - Python: ${{ matrix.python-version }}
          - OS: ${{ matrix.os }}
          - Commit: ${{ github.sha }}